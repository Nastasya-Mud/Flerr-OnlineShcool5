# Деплой на Render

Подробная инструкция по развертыванию платформы Flerr на Render.

## Предварительные требования

1. **Аккаунт Render**: Зарегистрируйтесь на [render.com](https://render.com)
2. **MongoDB**: Создайте базу данных на [MongoDB Atlas](https://www.mongodb.com/cloud/atlas) или используйте другой MongoDB хостинг
3. **S3 хранилище**: Настройте S3-совместимое хранилище (AWS S3, Backblaze B2, или MinIO)
4. **SMTP**: Настройте SMTP для отправки email (Gmail, SendGrid, Mailgun и т.д.)

## Шаг 1: Подготовка MongoDB

### MongoDB Atlas (рекомендуется)

1. Перейдите на [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
2. Создайте бесплатный кластер
3. Создайте пользователя базы данных
4. Получите connection string (выглядит как `mongodb+srv://...`)
5. Добавьте IP адрес `0.0.0.0/0` в Network Access (для доступа с Render)

## Шаг 2: Настройка S3 хранилища

### Вариант 1: AWS S3

1. Создайте S3 bucket
2. Создайте IAM пользователя с правами на чтение/запись bucket
3. Получите Access Key ID и Secret Access Key
4. Настройте CORS для bucket

### Вариант 2: Backblaze B2 (дешевле)

1. Создайте bucket на [backblaze.com/b2](https://www.backblaze.com/b2/)
2. Создайте Application Key
3. Получите endpoint URL, bucket name и ключи

### Вариант 3: MinIO (самохостинг)

1. Развертывайте MinIO на своем сервере
2. Создайте bucket
3. Получите credentials

## Шаг 3: Настройка SMTP

### Gmail

1. Включите 2FA на аккаунте Google
2. Создайте App Password в настройках безопасности
3. Используйте:
   - Host: `smtp.gmail.com`
   - Port: `587`
   - User: ваш email
   - Pass: app password

### SendGrid / Mailgun

Создайте аккаунт и получите SMTP credentials

## Шаг 4: Деплой на Render

### Автоматический деплой через render.yaml

1. Форкните или загрузите репозиторий на GitHub
2. Зайдите в [Render Dashboard](https://dashboard.render.com)
3. Нажмите **New → Blueprint**
4. Подключите ваш GitHub репозиторий
5. Render автоматически обнаружит `render.yaml`
6. Заполните переменные окружения:

#### Backend (flerr-server):

```
MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/flerr
JWT_SECRET=<auto-generated>
JWT_REFRESH_SECRET=<auto-generated>
S3_ENDPOINT=https://s3.us-east-1.amazonaws.com
S3_REGION=us-east-1
S3_BUCKET=flerr-videos
S3_ACCESS_KEY=your_access_key
S3_SECRET_KEY=your_secret_key
APP_BASE_URL=https://flerr-web.onrender.com
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your@email.com
SMTP_PASS=your_app_password
```

#### Frontend (flerr-web):

```
VITE_API_URL=https://flerr-server.onrender.com
```

7. Нажмите **Apply** и дождитесь завершения деплоя

### Ручной деплой

#### Backend Service

1. New → Web Service
2. Connect repository
3. Настройки:
   - **Name**: `flerr-server`
   - **Environment**: Node
   - **Branch**: main
   - **Build Command**: `npm install && npm run build:server`
   - **Start Command**: `npm start`
   - **Plan**: Free
4. Добавьте переменные окружения (см. выше)
5. Deploy

#### Frontend Service

1. New → Static Site
2. Connect repository
3. Настройки:
   - **Name**: `flerr-web`
   - **Branch**: main
   - **Build Command**: `cd apps/web && npm install && npm run build`
   - **Publish Directory**: `apps/web/dist`
4. Добавьте переменную `VITE_API_URL` с URL вашего backend сервиса
5. Deploy

## Шаг 5: Заполнение тестовыми данными

1. Откройте Shell в backend сервисе (flerr-server) в Render Dashboard
2. Выполните команду:
   ```bash
   npm run seed
   ```

Будут созданы:
- Администратор: `admin@flerr.ru` / `admin123`
- Студент: `student@flerr.ru` / `student123`
- Тестовые курсы и уроки
- Промокоды: `WELCOME2024`, `FLOWERS101`, `WEDDING2024`

## Шаг 6: Настройка кастомного домена (опционально)

### Backend

1. Перейдите в настройки `flerr-server`
2. Settings → Custom Domain
3. Добавьте ваш домен (например, `api.flerr.ru`)
4. Настройте DNS CNAME запись на Render URL

### Frontend

1. Перейдите в настройки `flerr-web`
2. Settings → Custom Domain
3. Добавьте ваш домен (например, `flerr.ru`)
4. Настройте DNS CNAME или A запись

### Обновите переменные окружения

После настройки доменов обновите:
- В backend: `APP_BASE_URL=https://flerr.ru`
- В frontend: `VITE_API_URL=https://api.flerr.ru`

## Шаг 7: Настройка CDN для видео (рекомендуется)

Для оптимизации отдачи видео настройте CloudFlare или другой CDN перед S3:

1. Создайте аккаунт на [CloudFlare](https://cloudflare.com)
2. Настройте R2 или подключите ваш S3 bucket
3. Настройте кеширование для видео файлов
4. Обновите `S3_ENDPOINT` на CDN URL

## Шаг 8: Мониторинг и логи

### Логи

В Render Dashboard → Logs можно просмотреть логи приложения в реальном времени

### Метрики

В разделе Metrics доступна информация о:
- CPU и Memory использовании
- Количестве запросов
- Response time

### Алерты

Настройте уведомления о проблемах в Settings → Notifications

## Автоматические деплои

Render автоматически развертывает изменения при push в ветку main/master.

Отключить автодеплой: Settings → Auto-Deploy → Off

## Проблемы и решения

### Backend не запускается

1. Проверьте логи на наличие ошибок подключения к MongoDB
2. Убедитесь, что все переменные окружения заданы
3. Проверьте, что IP адрес Render добавлен в MongoDB Network Access

### Frontend не загружается

1. Проверьте, что `VITE_API_URL` указывает на правильный URL backend
2. Убедитесь, что CORS настроен на backend для вашего frontend домена
3. Проверьте build logs на наличие ошибок

### Видео не воспроизводятся

1. Проверьте S3 credentials
2. Убедитесь, что bucket существует и доступен
3. Проверьте, что backend генерирует signed URLs корректно
4. Проверьте CORS настройки на S3 bucket

### Ошибки авторизации

1. Проверьте, что JWT_SECRET установлен
2. Очистите cookies и localStorage в браузере
3. Проверьте, что refresh token endpoint работает

## Масштабирование

### Платные планы

Для production использования рекомендуется:
- Backend: Starter Plan ($7/месяц) или выше
- Frontend: Оставить на Free (Static Site)
- MongoDB: Dedicated cluster на Atlas

### Оптимизация

1. Включите Redis для кеширования (можно добавить Redis service на Render)
2. Настройте CDN для статики
3. Оптимизируйте размер видео файлов
4. Используйте индексы в MongoDB

## Бэкапы

### MongoDB

Настройте автоматические бэкапы в MongoDB Atlas

### S3

Включите versioning в S3 bucket для защиты от случайного удаления

## Безопасность

1. **Secrets**: Храните все секреты в Render Environment Variables
2. **CORS**: Настройте строгие CORS правила на backend
3. **Rate Limiting**: Уже настроен на auth и promo эндпоинтах
4. **HTTPS**: Render автоматически предоставляет SSL сертификаты
5. **MongoDB**: Используйте сильные пароли и ограничьте Network Access

## Стоимость

### Минимальная конфигурация (Free)
- Render Backend: Free (спящий режим после 15 мин неактивности)
- Render Frontend: Free
- MongoDB Atlas: Free (512MB)
- Backblaze B2: Free (10GB)
- **Итого**: $0/месяц

### Рекомендуемая конфигурация (Production)
- Render Backend: Starter ($7/месяц)
- Render Frontend: Free
- MongoDB Atlas: M10 ($10/месяц)
- Backblaze B2: ~$0.005/GB хранения + $0.01/GB трафика
- CloudFlare CDN: Free
- **Итого**: ~$17-25/месяц

## Поддержка

При возникновении проблем:
1. Проверьте логи в Render Dashboard
2. Изучите документацию Render: [render.com/docs](https://render.com/docs)
3. Проверьте README.md проекта

